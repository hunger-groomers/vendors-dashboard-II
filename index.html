import { useState, useEffect } from 'react';

// Configuration for API credentials and endpoints
const CONFIG = {
  // Google Sheets API - Replace these with your actual credentials
  SHEETS_API: {
    API_KEY: 'YOUR_GOOGLE_API_KEY',
    SPREADSHEET_ID: 'YOUR_SPREADSHEET_ID',
    SCOPE: 'https://www.googleapis.com/auth/spreadsheets'
  },
  // SMS Gateway for OTP - Replace with your service provider details
  SMS_GATEWAY: {
    API_KEY: 'YOUR_SMS_API_KEY',
    ENDPOINT: 'https://api.smsgateway.com/send'
  },
  // Payment Gateway - Replace with your preferred payment provider
  PAYMENT_GATEWAY: {
    API_KEY: 'YOUR_PAYMENT_API_KEY',
    MERCHANT_ID: 'YOUR_MERCHANT_ID',
    ENDPOINT: 'https://api.paymentgateway.com/process'
  },
  // Default radius in kilometers
  DEFAULT_RADIUS: 1,
  // Price to extend radius (in rupees)
  RADIUS_EXTENSION_PRICE: 10
};

// Logo component with updated SVG based on provided logo
const Logo = ({ size = "large", className = "" }) => {
  const sizes = {
    small: "h-8",
    medium: "h-12",
    large: "h-16",
    xlarge: "h-24"
  };
  
  return (
    <div className={`flex items-center justify-center ${className}`}>
      <div className={`${sizes[size]} relative`}>
        <svg viewBox="0 0 800 250" className="h-full">
          {/* H letter */}
          <text x="0" y="180" fontSize="200" fontWeight="bold" fill="#17803A">H</text>
          
          {/* Tiffin bowl logo in place of O */}
          <g transform="translate(220, 60) scale(0.8)">
            <ellipse cx="100" cy="70" rx="90" ry="40" fill="#111111" /> {/* Bowl top */}
            <rect x="20" y="70" width="160" height="60" fill="#111111" /> {/* Bowl body */}
            <ellipse cx="100" cy="130" rx="80" ry="30" fill="#111111" /> {/* Bowl bottom */}
            <ellipse cx="100" cy="60" rx="70" ry="30" fill="#f5f5f5" /> {/* Rice top */}
            <path d="M50,60 Q80,30 150,60" stroke="#f5f5f5" strokeWidth="8" fill="none" /> {/* Rice detail */}
            <path d="M60,55 Q90,35 140,55" stroke="#f5f5f5" strokeWidth="5" fill="none" /> {/* Rice detail */}
          </g>
          
          {/* NGER letters */}
          <text x="320" y="180" fontSize="200" fontWeight="bold" fill="#17803A">NGER</text>
          
          {/* GROOMERS text */}
          <text x="90" y="240" fontSize="110" fontWeight="bold" fill="#17803A">GROOMERS</text>
        </svg>
      </div>
    </div>
  );
};

// Theme colors
const THEME = {
  primary: 'bg-green-600 hover:bg-green-700',
  secondary: 'bg-gray-100 text-green-600 border border-green-600 hover:bg-green-50',
  accent: 'text-green-600'
};

export default function TiffinDeliveryApp() {
  // User authentication states
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [user, setUser] = useState({
    name: '',
    email: '',
    phone: '',
    location: '',
    coordinates: {
      latitude: null,
      longitude: null
    }
  });
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    otp: '',
    location: '',
    paymentMethod: 'cod'
  });
  const [otpSent, setOtpSent] = useState(false);
  const [otpVerified, setOtpVerified] = useState(false);
  
  // App view states
  const [currentView, setCurrentView] = useState('login'); // login, location, tiffinCenters, radiusExtension, packageSelection, checkout, trackOrder
  const [selectedTiffinCenter, setSelectedTiffinCenter] = useState(null);
  const [selectedPackage, setSelectedPackage] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [activeTab, setActiveTab] = useState('signup');
  
  // Location and radius states
  const [userRadius, setUserRadius] = useState(CONFIG.DEFAULT_RADIUS);
  const [radiusExtended, setRadiusExtended] = useState(false);
  const [locationPermission, setLocationPermission] = useState(false);
  const [locationLoading, setLocationLoading] = useState(false);
  
  // Delivery tracking states
  const [currentOrder, setCurrentOrder] = useState(null);
  const [deliveryPartner, setDeliveryPartner] = useState(null);
  const [deliveryStatus, setDeliveryStatus] = useState(null);
  const [deliveryETA, setDeliveryETA] = useState(null);
  
  // Additional UI states
  const [showOrderSuccess, setShowOrderSuccess] = useState(false);
  const [showRadiusModal, setShowRadiusModal] = useState(false);
  const [countdown, setCountdown] = useState(0);
  const [resendDisabled, setResendDisabled] = useState(false);
  
  // Mock data
  const tiffinCenters = [
    { 
      id: 1, 
      name: 'Healthy Bites', 
      rating: 4.5, 
      hygiene: 4.7, 
      taste: 4.3, 
      image: '/api/placeholder/400/200', 
      popular: true,
      description: 'Home-cooked meals made with fresh ingredients and delivered on time.',
      location: {
        address: 'Plot 123, Sector 10, Dwarka, New Delhi',
        coordinates: {
          latitude: 28.5823,
          longitude: 77.0497
        }
      },
      distance: 0.8, // will be calculated based on user location
      packages: [
        { id: 1, name: '10 Days', price: 999, description: 'Lunch tiffin for 10 days' },
        { id: 2, name: '15 Days', price: 1399, description: 'Lunch tiffin for 15 days' },
        { id: 3, name: '30 Days', price: 2499, description: 'Lunch tiffin for 30 days' },
        { id: 4, name: 'Single Meal', price: 120, description: 'Try once before committing' }
      ]
    },
    { 
      id: 2, 
      name: 'Mom\'s Kitchen', 
      rating: 4.8, 
      hygiene: 4.9, 
      taste: 4.7, 
      image: '/api/placeholder/400/200',
      popular: true,
      description: 'Authentic home-style cooking with a variety of regional cuisines.',
      location: {
        address: 'Shop 78, Karol Bagh, New Delhi',
        coordinates: {
          latitude: 28.6579,
          longitude: 77.1968
        }
      },
      distance: 1.2, // will be calculated based on user location
      packages: [
        { id: 1, name: '10 Days', price: 1199, description: 'Premium lunch tiffin for 10 days' },
        { id: 2, name: '15 Days', price: 1699, description: 'Premium lunch tiffin for 15 days' },
        { id: 3, name: '30 Days', price: 2999, description: 'Premium lunch tiffin for 30 days' },
        { id: 4, name: 'Single Meal', price: 150, description: 'Try once before committing' }
      ]
    },
    { 
      id: 3, 
      name: 'Office Bites', 
      rating: 4.2, 
      hygiene: 4.3, 
      taste: 4.0, 
      image: '/api/placeholder/400/200',
      popular: false,
      description: 'Budget-friendly options perfect for office workers.',
      location: {
        address: '45/2, Connaught Place, New Delhi',
        coordinates: {
          latitude: 28.6315,
          longitude: 77.2167
        }
      },
      distance: 2.5, // will be calculated based on user location
      packages: [
        { id: 1, name: '10 Days', price: 899, description: 'Budget lunch tiffin for 10 days' },
        { id: 2, name: '15 Days', price: 1299, description: 'Budget lunch tiffin for 15 days' },
        { id: 3, name: '30 Days', price: 2299, description: 'Budget lunch tiffin for 30 days' },
        { id: 4, name: 'Single Meal', price: 100, description: 'Try once before committing' }
      ]
    },
    { 
      id: 4, 
      name: 'Homely Meals', 
      rating: 4.6, 
      hygiene: 4.5, 
      taste: 4.7, 
      image: '/api/placeholder/400/200',
      popular: true,
      description: 'Traditional recipes prepared with love just like at home.',
      location: {
        address: '34, Mayur Vihar Phase 1, Delhi',
        coordinates: {
          latitude: 28.6098,
          longitude: 77.2913
        }
      },
      distance: 3.1, // will be calculated based on user location
      packages: [
        { id: 1, name: '10 Days', price: 1099, description: 'Home-style lunch tiffin for 10 days' },
        { id: 2, name: '15 Days', price: 1599, description: 'Home-style lunch tiffin for 15 days' },
        { id: 3, name: '30 Days', price: 2799, description: 'Home-style lunch tiffin for 30 days' },
        { id: 4, name: 'Single Meal', price: 130, description: 'Try once before committing' }
      ]
    }
  ];

  const paymentMethods = [
    { id: 'cod', name: 'Cash on Delivery', icon: '💵' },
    { id: 'upi', name: 'UPI / Google Pay', icon: '📱', coming: true },
    { id: 'card', name: 'Credit / Debit Card', icon: '💳', coming: true }
  ];

  // Mock delivery partners
  const deliveryPartners = [
    { id: 1, name: "Rajesh Kumar", phone: "9812345678", rating: 4.7, image: "/api/placeholder/100/100" },
    { id: 2, name: "Sunil Sharma", phone: "9823456789", rating: 4.5, image: "/api/placeholder/100/100" },
    { id: 3, name: "Amit Singh", phone: "9834567890", rating: 4.8, image: "/api/placeholder/100/100" }
  ];
  
  // Google Sheets API integration
  const googleSheetsAPI = {
    init: async () => {
      // For real implementation, load the Google Sheets API client
      try {
        // In production, uncomment and use this code:
        /*
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://apis.google.com/js/api.js';
          script.onload = resolve;
          script.onerror = reject;
          document.body.appendChild(script);
        });
        
        await new Promise((resolve, reject) => {
          window.gapi.load('client:auth2', resolve);
        });
        
        await window.gapi.client.init({
          apiKey: CONFIG.SHEETS_API.API_KEY,
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
          scope: CONFIG.SHEETS_API.SCOPE
        });
        */
        
        // For now, just check if localStorage is available
        return Boolean(window.localStorage);
      } catch (error) {
        console.error('Failed to initialize Google Sheets API:', error);
        return false;
      }
    },
    
    checkUserExists: async (email) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll use localStorage
      const savedUsers = JSON.parse(localStorage.getItem('tiffinAppUsers') || '[]');
      return savedUsers.some(user => user.email === email);
    },
    
    saveUser: async (userData) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll use localStorage
      const savedUsers = JSON.parse(localStorage.getItem('tiffinAppUsers') || '[]');
      savedUsers.push(userData);
      localStorage.setItem('tiffinAppUsers', JSON.stringify(savedUsers));
      return true;
    },
    
    validateUser: async (email, phone) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll use localStorage
      const savedUsers = JSON.parse(localStorage.getItem('tiffinAppUsers') || '[]');
      return savedUsers.find(user => user.email === email && user.phone === phone) || null;
    },
    
    saveOrder: async (orderData) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll use localStorage
      const savedOrders = JSON.parse(localStorage.getItem('tiffinAppOrders') || '[]');
      const newOrder = {
        ...orderData,
        orderId: `ORD-${Date.now()}`,
        orderDate: new Date().toISOString()
      };
      savedOrders.push(newOrder);
      localStorage.setItem('tiffinAppOrders', JSON.stringify(savedOrders));
      return newOrder;
    }
  };
  
  // SMS Gateway integration for OTP verification
  const smsGateway = {
    sendOTP: async (phone) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll generate a random OTP and store it in localStorage
      const otp = Math.floor(1000 + Math.random() * 9000).toString();
      localStorage.setItem('currentOTP', otp);
      console.log('OTP sent:', otp); // In real app, remove this
      return true;
    },
    
    verifyOTP: async (inputOTP) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll check against localStorage
      const storedOTP = localStorage.getItem('currentOTP');
      return storedOTP === inputOTP;
    }
  };
  
  // Payment Gateway integration
  const paymentGateway = {
    processPayment: async (paymentDetails) => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // For demo, we'll simulate a successful payment
      return {
        success: true,
        transactionId: `TXN-${Date.now()}`,
        message: 'Payment processed successfully'
      };
    },
    
    extendRadius: async () => {
      // Simulating API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Process payment for radius extension
      return {
        success: true,
        transactionId: `RAD-${Date.now()}`,
        message: 'Radius extension payment successful'
      };
    }
  };

  // Geolocation utilities
  const geoLocation = {
    // Get current position
    getCurrentPosition: () => {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation is not supported by your browser'));
          return;
        }
        
        navigator.geolocation.getCurrentPosition(
          position => {
            resolve({
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            });
          },
          error => {
            reject(error);
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      });
    },
    
    // Calculate distance between two coordinates using Haversine formula (in km)
    calculateDistance: (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Radius of the Earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c; // Distance in km
      return parseFloat(distance.toFixed(1));
    },
    
    // Get address from coordinates using reverse geocoding
    getAddressFromCoordinates: async (latitude, longitude) => {
      // In a real implementation, you would use a geocoding service like Google Maps API
      // For demo, we'll just return coordinates as string
      return `Lat: ${latitude}, Lng: ${longitude}`;
      
      /* Example implementation with Google Maps API:
      try {
        const response = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&key=YOUR_API_KEY`
        );
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          return data.results[0].formatted_address;
        }
        return `Lat: ${latitude}, Lng: ${longitude}`;
      } catch (error) {
        console.error('Geocoding error:', error);
        return `Lat: ${latitude}, Lng: ${longitude}`;
      }
      */
    }
  };
  
  // Delivery Tracking Simulation
  const deliveryTracking = {
    // Initialize tracking for an order
    initializeTracking: async (orderId) => {
      // Simulate API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Randomly select a delivery partner
      const randomPartner = deliveryPartners[Math.floor(Math.random() * deliveryPartners.length)];
      
      // Calculate random ETA between 20-40 minutes
      const etaMinutes = Math.floor(Math.random() * 20) + 20;
      const now = new Date();
      const eta = new Date(now.getTime() + etaMinutes * 60000);
      
      // Return tracking information
      return {
        orderId,
        status: 'Preparing',
        partner: randomPartner,
        eta: eta.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        etaMinutes
      };
    },
    
    // Update tracking status
    updateTrackingStatus: async (trackingInfo) => {
      // Simulate status progression based on time elapsed
      const statusFlow = ['Preparing', 'Ready for pickup', 'Picked up', 'On the way', 'Arriving', 'Delivered'];
      const currentStatusIndex = statusFlow.indexOf(trackingInfo.status);
      
      if (currentStatusIndex < statusFlow.length - 1) {
        // Move to next status
        const newStatus = statusFlow[currentStatusIndex + 1];
        
        return {
          ...trackingInfo,
          status: newStatus
        };
      }
      
      return trackingInfo;
    }
  };
  
  useEffect(() => {
    // Initialize Google Sheets API
    const initAPI = async () => {
      try {
        const initialized = await googleSheetsAPI.init();
        if (!initialized) {
          setError('Failed to initialize API. Please try again later.');
        }
      } catch (err) {
        console.error('API initialization error:', err);
        setError('API initialization failed. Please try again later.');
      }
    };
    
    initAPI();
    
    // Check if user is already logged in
    const savedSession = localStorage.getItem('tiffinAppSession');
    if (savedSession) {
      const sessionData = JSON.parse(savedSession);
      setUser(sessionData);
      setIsLoggedIn(true);
      setCurrentView('tiffinCenters');
      
      // Check if radius was extended
      const radiusStatus = localStorage.getItem('tiffinAppRadiusExtended');
      if (radiusStatus === 'true') {
        setRadiusExtended(true);
        setUserRadius(Infinity); // No radius limit
      }
    }
  }, []);
  
  // Update tiffin center distances when user location changes
  useEffect(() => {
    if (user.coordinates.latitude && user.coordinates.longitude) {
      const updatedCenters = tiffinCenters.map(center => {
        const distance = geoLocation.calculateDistance(
          user.coordinates.latitude,
          user.coordinates.longitude,
          center.location.coordinates.latitude,
          center.location.coordinates.longitude
        );
        return { ...center, distance };
      });
      
      // Sort centers by distance
      updatedCenters.sort((a, b) => a.distance - b.distance);
      
      // Update centers with calculated distances
      // In a real app, you would update state with the new centers
      console.log('Updated centers with distances:', updatedCenters);
    }
  }, [user.coordinates]);
  
  // Delivery tracking simulation
  useEffect(() => {
    let trackingInterval;
    
    if (currentOrder && deliveryStatus && deliveryStatus !== 'Delivered') {
      trackingInterval = setInterval(async () => {
        const updatedTracking = await deliveryTracking.updateTrackingStatus({
          orderId: currentOrder.orderId,
          status: deliveryStatus,
          partner: deliveryPartner,
          eta: deliveryETA
        });
        
        setDeliveryStatus(updatedTracking.status);
        
        if (updatedTracking.status === 'Delivered') {
          clearInterval(trackingInterval);
        }
      }, 10000); // Update every 10 seconds for demo
    }
    
    return () => {
      if (trackingInterval) clearInterval(trackingInterval);
    };
  }, [currentOrder, deliveryStatus]);
  
  // Countdown timer for OTP resend
  useEffect(() => {
    if (countdown > 0) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
      return () => clearTimeout(timer);
    } else if (countdown === 0 && resendDisabled) {
      setResendDisabled(false);
    }
  }, [countdown, resendDisabled]);
  
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData({
      ...formData,
      [name]: value
    });
  };
  
  const handleSignup = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      // Check if user already exists
      const userExists = await googleSheetsAPI.checkUserExists(formData.email);
      
      if (userExists) {
        setError('User with this email already exists. Please log in instead.');
        setLoading(false);
        return;
      }
      
      // Send OTP
      await smsGateway.sendOTP(formData.phone);
      setOtpSent(true);
      setCountdown(30);
      setResendDisabled(true);
      setLoading(false);
    } catch (err) {
      console.error('Signup error:', err);
      setError('Something went wrong. Please try again.');
      setLoading(false);
    }
  };
  
  const handleResendOTP = async () => {
    if (resendDisabled) return;
    
    setLoading(true);
    try {
      await smsGateway.sendOTP(formData.phone);
      setCountdown(30);
      setResendDisabled(true);
      setLoading(false);
    } catch (err) {
      console.error('OTP resend error:', err);
      setError('Failed to resend OTP. Please try again.');
      setLoading(false);
    }
  };
  
  const handleVerifyOTP = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      const isVerified = await smsGateway.verifyOTP(formData.otp);
      
      if (isVerified) {
        // Save user data
        const newUser = {
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          joinedDate: new Date().toISOString(),
          coordinates: {
            latitude: null,
            longitude: null
          }
        };
        
        await googleSheetsAPI.saveUser(newUser);
        
        // Set session
        localStorage.setItem('tiffinAppSession', JSON.stringify(newUser));
        
        // Update app state
        setUser(newUser);
        setIsLoggedIn(true);
        setOtpVerified(true);
        setCurrentView('location');
      } else {
        setError('Invalid OTP. Please try again.');
      }
      
      setLoading(false);
    } catch (err) {
      console.error('OTP verification error:', err);
      setError('Something went wrong. Please try again.');
      setLoading(false);
    }
  };
  
  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      const userData = await googleSheetsAPI.validateUser(formData.email, formData.phone);
      
      if (userData) {
        // Set session
        localStorage.setItem('tiffinAppSession', JSON.stringify(userData));
        
        // Check if radius was extended previously
        const radiusStatus = localStorage.getItem('tiffinAppRadiusExtended');
        if (radiusStatus === 'true') {
          setRadiusExtended(true);
          setUserRadius(Infinity); // No radius limit
        }
        
        // Update app state
        setUser(userData);
        setIsLoggedIn(true);
        
        // Go to location page if coordinates aren't set
        if (!userData.coordinates || !userData.coordinates.latitude) {
          setCurrentView('location');
        } else {
          setCurrentView('tiffinCenters');
        }
      } else {
        setError('Invalid credentials. Please try again.');
      }
      
      setLoading(false);
    } catch (err) {
      console.error('Login error:', err);
      setError('Something went wrong. Please try again.');
      setLoading(false);
    }
  };
  
  const handleLogout = () => {
    localStorage.removeItem('tiffinAppSession');
    setIsLoggedIn(false);
    setUser({
      name: '',
      email: '',
      phone: '',
      location: '',
      coordinates: {
        latitude: null,
        longitude: null
      }
    });
    setCurrentView('login');
  };
  
  const handleLocationSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.location.trim()) {
      setError('Please enter your delivery location');
      return;
    }
    
    setLoading(true);
    
    try {
      const userWithLocation = {
        ...user,
        location: formData.location
      };
      
      // Update user state and session
      setUser(userWithLocation);
      localStorage.setItem('tiffinAppSession', JSON.stringify(userWithLocation));
      
      // Move to next view
      setCurrentView('tiffinCenters');
      setLoading(false);
    } catch (err) {
      console.error('Location update error:', err);
      setError('Failed to update location. Please try again.');
      setLoading(false);
    }
  };

  // Complete the getCurrentLocation function for automatic location detection
  const handleGetCurrentLocation = async () => {
    setLocationLoading(true);
    setError('');
    
    try {
      const position = await geoLocation.getCurrentPosition();
      const address = await geoLocation.getAddressFromCoordinates(
        position.latitude, 
        position.longitude
      );
      
      const userWithLocation = {
        ...user,
        location: address,
        coordinates: {
          latitude: position.latitude,
          longitude: position.longitude
        }
      };
      
      // Update form data, user state and session
      setFormData({
        ...formData,
        location: address
      });
      setUser(userWithLocation);
      localStorage.setItem('tiffinAppSession', JSON.stringify(userWithLocation));
      setLocationPermission(true);
      
    } catch (err) {
      console.error('Geolocation error:', err);
      setError('Failed to get your location. Please allow location access or enter manually.');
      setLocationPermission(false);
    } finally {
      setLocationLoading(false);
    }
  };

  // Filter tiffin centers based on radius
  const filterTiffinCentersByRadius = (centers, userLocation, radius) => {
    if (!userLocation.latitude || !userLocation.longitude) return centers;
    
    return centers.filter(center => {
      const distance = geoLocation.calculateDistance(
        userLocation.latitude,
        userLocation.longitude,
        center.location.coordinates.latitude,
        center.location.coordinates.longitude
      );
      return distance <= radius;
    });
  };

 // Radius extension functionality
  const handleRadiusExtension = async () => {
    setLoading(true);
    
    try {
      // Process payment for radius extension
      const paymentResult = await paymentGateway.extendRadius();
      
      if (paymentResult.success) {
        // Update radius settings
        setRadiusExtended(true);
        setUserRadius(Infinity); // No radius limit
        localStorage.setItem('tiffinAppRadiusExtended', 'true');
        
        // Close radius modal
        setShowRadiusModal(false);
        
        // Update view to show all tiffin centers
        setCurrentView('tiffinCenters');
      } else {
        setError('Payment failed. Please try again.');
      }
    } catch (err) {
      console.error('Radius extension error:', err);
      setError('Failed to extend radius. Please try again.');
    } finally {
      setLoading(false);
    }
  };
  
  // Handle selecting a tiffin center
  const handleSelectTiffinCenter = (center) => {
    setSelectedTiffinCenter(center);
    setCurrentView('packageSelection');
  };
  
  // Handle selecting a package
  const handleSelectPackage = (pkg) => {
    setSelectedPackage(pkg);
    setCurrentView('checkout');
  };
  
  // Handle checkout process
  const handleCheckout = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      // For cash on delivery, we don't need to process payment
      // For other payment methods, we would call paymentGateway.processPayment
      
      const orderData = {
        userId: user.email,
        userName: user.name,
        userPhone: user.phone,
        userLocation: user.location,
        tiffinCenterId: selectedTiffinCenter.id,
        tiffinCenterName: selectedTiffinCenter.name,
        packageId: selectedPackage.id,
        packageName: selectedPackage.name,
        packagePrice: selectedPackage.price,
        paymentMethod: formData.paymentMethod,
        deliveryCoordinates: user.coordinates
      };
      
      // Save order to database (Google Sheets in this case)
      const savedOrder = await googleSheetsAPI.saveOrder(orderData);
      
      // Initialize delivery tracking
      const trackingInfo = await deliveryTracking.initializeTracking(savedOrder.orderId);
      
      // Update app state
      setCurrentOrder(savedOrder);
      setDeliveryPartner(trackingInfo.partner);
      setDeliveryStatus(trackingInfo.status);
      setDeliveryETA(trackingInfo.eta);
      
      // Show success screen and then move to tracking view
      setShowOrderSuccess(true);
      setTimeout(() => {
        setShowOrderSuccess(false);
        setCurrentView('trackOrder');
      }, 3000);
      
      setLoading(false);
    } catch (err) {
      console.error('Checkout error:', err);
      setError('Something went wrong with your order. Please try again.');
      setLoading(false);
    }
  };
  
  // Handle changing payment method
  const handlePaymentMethodChange = (method) => {
    if (method.coming) {
      setError('This payment method is coming soon!');
      return;
    }
    
    setFormData({
      ...formData,
      paymentMethod: method.id
    });
  };
  
  // Navigation helper functions
  const goToView = (view) => {
    setCurrentView(view);
    setError('');
  };
  
  // Switch between login and signup tabs
  const switchTab = (tab) => {
    setActiveTab(tab);
    setError('');
  };

  // Render authentication view (login/signup)
  const renderAuthView = () => {
    return (
      <div className="flex flex-col items-center w-full max-w-md mx-auto p-4">
        <Logo size="large" className="mb-6" />
        
        <div className="bg-white rounded-lg shadow-lg w-full">
          {/* Tabs */}
          <div className="flex border-b">
            <button 
              className={`flex-1 py-3 font-medium ${activeTab === 'signup' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500'}`}
              onClick={() => switchTab('signup')}
            >
              Sign Up
            </button>
            <button 
              className={`flex-1 py-3 font-medium ${activeTab === 'login' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500'}`}
              onClick={() => switchTab('login')}
            >
              Login
            </button>
          </div>
          
          {/* Sign Up Form */}
          {activeTab === 'signup' && !otpSent && (
            <form onSubmit={handleSignup} className="p-6">
              <div className="mb-4">
                <label className="block text-gray-700 text-sm font-medium mb-1">Full Name</label>
                <input
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                  placeholder="Enter your full name"
                  required
                />
              </div>
              
              <div className="mb-4">
                <label className="block text-gray-700 text-sm font-medium mb-1">Email</label>
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                  placeholder="Enter your email"
                  required
                />
              </div>
              
              <div className="mb-6">
                <label className="block text-gray-700 text-sm font-medium mb-1">Phone Number</label>
                <input
                  type="tel"
                  name="phone"
                  value={formData.phone}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                  placeholder="Enter your phone number"
                  required
                />
              </div>
              
              {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
              
              <button
                type="submit"
                className={`w-full py-2 px-4 rounded-md text-white font-medium ${THEME.primary} ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
                disabled={loading}
              >
                {loading ? 'Sending OTP...' : 'Send OTP'}
              </button>
            </form>
          )}
          
          {/* OTP Verification Form */}
          {activeTab === 'signup' && otpSent && !otpVerified && (
            <form onSubmit={handleVerifyOTP} className="p-6">
              <div className="mb-6">
                <label className="block text-gray-700 text-sm font-medium mb-1">Enter OTP</label>
                <input
                  type="text"
                  name="otp"
                  value={formData.otp}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                  placeholder="Enter 4-digit OTP"
                  required
                />
              </div>
              
              {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
              
              <button
                type="submit"
                className={`w-full py-2 px-4 rounded-md text-white font-medium mb-4 ${THEME.primary} ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
                disabled={loading}
              >
                {loading ? 'Verifying...' : 'Verify OTP'}
              </button>
              
              <div className="text-center">
                <button
                  type="button"
                  onClick={handleResendOTP}
                  className={`text-green-600 text-sm font-medium ${resendDisabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                  disabled={resendDisabled}
                >
                  {countdown > 0 ? `Resend OTP in ${countdown}s` : 'Resend OTP'}
                </button>
              </div>
            </form>
          )}
          
          {/* Login Form */}
          {activeTab === 'login' && (
            <form onSubmit={handleLogin} className="p-6">
              <div className="mb-4">
                <label className="block text-gray-700 text-sm font-medium mb-1">Email</label>
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                  placeholder="Enter your email"
                  required
                />
              </div>
              
              <div className="mb-6">
                <label className="block text-gray-700 text-sm font-medium mb-1">Phone Number</label>
                <input
                  type="tel"
                  name="phone"
                  value={formData.phone}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                  placeholder="Enter your phone number"
                  required
                />
              </div>
              
              {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
              
              <button
                type="submit"
                className={`w-full py-2 px-4 rounded-md text-white font-medium ${THEME.primary} ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
                disabled={loading}
              >
                {loading ? 'Logging in...' : 'Login'}
              </button>
            </form>
          )}
        </div>
      </div>
    );
  };
  
  // Render location collection view
  const renderLocationView = () => {
    return (
      <div className="flex flex-col items-center w-full max-w-md mx-auto p-4">
        <Logo size="medium" className="mb-6" />
        
        <div className="bg-white rounded-lg shadow-lg w-full p-6">
          <h2 className="text-xl font-semibold mb-4">Set Your Delivery Location</h2>
          
          <form onSubmit={handleLocationSubmit}>
            <div className="mb-6">
              <label className="block text-gray-700 text-sm font-medium mb-1">Delivery Address</label>
              <input
                type="text"
                name="location"
                value={formData.location}
                onChange={handleInputChange}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                placeholder="Enter your delivery address"
                required
              />
            </div>
            
            {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
            
            <button
              type="button"
              onClick={handleGetCurrentLocation}
              className={`w-full py-2 px-4 rounded-md font-medium mb-3 ${THEME.secondary} ${locationLoading ? 'opacity-70 cursor-not-allowed' : ''}`}
              disabled={locationLoading}
            >
              {locationLoading ? 'Getting Location...' : 'Use Current Location'}
            </button>
            
            <button
              type="submit"
              className={`w-full py-2 px-4 rounded-md text-white font-medium ${THEME.primary} ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
              disabled={loading}
            >
              {loading ? 'Submitting...' : 'Continue'}
            </button>
          </form>
        </div>
      </div>
    );
  };
  
  // Render tiffin centers view
  const renderTiffinCentersView = () => {
    const availableCenters = filterTiffinCentersByRadius(
      tiffinCenters, 
      user.coordinates, 
      radiusExtended ? Infinity : userRadius
    );
    
    return (
      <div className="flex flex-col w-full max-w-md mx-auto">
        {/* Header */}
        <div className="flex justify-between items-center p-4 bg-white shadow-sm">
          <Logo size="small" />
          <div className="flex items-center">
            <span className="text-sm mr-2">{user.name}</span>
            <button 
              onClick={handleLogout}
              className="text-gray-500 text-sm"
            >
              Logout
            </button>
          </div>
        </div>
        
        {/* Location Bar */}
        <div className="flex items-center bg-gray-100 p-3">
          <div className="flex-1">
            <p className="text-xs text-gray-500">DELIVERING TO</p>
            <p className="text-sm font-medium truncate">{user.location}</p>
          </div>
          <button 
            onClick={() => goToView('location')}
            className="text-green-600 text-sm font-medium"
          >
            Change
          </button>
        </div>
        
        {/* Tiffin Centers */}
        <div className="flex-1 bg-gray-50 p-4">
          <h2 className="text-lg font-semibold mb-4">Tiffin Centers Near You</h2>
          
          {availableCenters.length > 0 ? (
            <div className="space-y-4">
              {availableCenters.map(center => (
                <div 
                  key={center.id}
                  className="bg-white rounded-lg shadow overflow-hidden"
                  onClick={() => handleSelectTiffinCenter(center)}
                >
                  <img 
                    src={center.image} 
                    alt={center.name} 
                    className="w-full h-32 object-cover"
                  />
                  
                  <div className="p-3">
                    <div className="flex justify-between items-start">
                      <h3 className="font-semibold">{center.name}</h3>
                      {center.popular && (
                        <span className="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded">
                          Popular
                        </span>
                      )}
                    </div>
                    
                    <div className="flex items-center mt-1 text-sm">
                      <span className="mr-3 flex items-center">
                        <span className="text-yellow-500 mr-1">★</span>
                        {center.rating}
                      </span>
                      <span className="mr-3">Hygiene: {center.hygiene}</span>
                      <span>Taste: {center.taste}</span>
                    </div>
                    
                    <p className="text-gray-600 text-sm mt-2 truncate">
                      {center.description}
                    </p>
                    
                    <div className="flex justify-between items-center mt-3">
                      <span className="text-sm">{center.distance} km away</span>
                      <button className={`text-white text-sm px-3 py-1 rounded ${THEME.primary}`}>
                        View Menu
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="bg-white rounded-lg shadow p-4 text-center">
              <p className="text-gray-600 mb-4">No tiffin centers found within {userRadius} km radius</p>
              
              <button
                onClick={() => setShowRadiusModal(true)}
                className={`py-2 px-4 rounded-md text-white font-medium ${THEME.primary}`}
              >
                Extend Search Radius (₹{CONFIG.RADIUS_EXTENSION_PRICE})
              </button>
            </div>
          )}
        </div>
      </div>
    );
  };
  
  // Render package selection view
  const renderPackageSelectionView = () => {
    if (!selectedTiffinCenter) return null;
    
    return (
      <div className="flex flex-col w-full max-w-md mx-auto">
        {/* Header */}
        <div className="flex items-center p-4 bg-white shadow-sm">
          <button 
            onClick={() => goToView('tiffinCenters')}
            className="mr-3"
          >
            ←
          </button>
          <h2 className="font-semibold">Select Package</h2>
        </div>
        
        {/* Tiffin Center Details */}
        <div className="bg-white p-4 border-b">
          <div className="flex items-start">
            <img 
              src={selectedTiffinCenter.image} 
              alt={selectedTiffinCenter.name} 
              className="w-20 h-20 object-cover rounded mr-3"
            />
            <div>
              <h3 className="font-semibold">{selectedTiffinCenter.name}</h3>
              <div className="flex items-center mt-1 text-sm">
                <span className="mr-3 flex items-center">
                  <span className="text-yellow-500 mr-1">★</span>
                  {selectedTiffinCenter.rating}
                </span>
                <span>{selectedTiffinCenter.distance} km away</span>
              </div>
              <p className="text-gray-600 text-sm mt-1">
                {selectedTiffinCenter.location.address}
              </p>
            </div>
          </div>
        </div>
        
        {/* Package Options */}
        <div className="flex-1 bg-gray-50 p-4">
          <h3 className="text-lg font-semibold mb-4">Available Packages</h3>
          
          <div className="space-y-3">
            {selectedTiffinCenter.packages.map(pkg => (
              <div 
                key={pkg.id}
                className="bg-white rounded-lg shadow p-4"
                onClick={() => handleSelectPackage(pkg)}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-semibold">{pkg.name}</h4>
                    <p className="text-gray-600 text-sm mt-1">{pkg.description}</p>
                  </div>
                  <div className="font-semibold">₹{pkg.price}</div>
                </div>
                
                <button className={`w-full mt-3 py-2 px-4 rounded-md text-white font-medium ${THEME.primary}`}>
                  Select
                </button>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };
  
  // Render checkout view
  const renderCheckoutView = () => {
    if (!selectedTiffinCenter || !selectedPackage) return null;
    
    return (
      <div className="flex flex-col w-full max-w-md mx-auto">
        {/* Header */}
        <div className="flex items-center p-4 bg-white shadow-sm">
          <button 
            onClick={() => goToView('packageSelection')}
            className="mr-3"
          >
            ←
          </button>
          <h2 className="font-semibold">Checkout</h2>
        </div>
        
        {/* Order Summary */}
        <div className="bg-white p-4 border-b">
          <h3 className="font-semibold mb-2">Order Summary</h3>
          
          <div className="flex justify-between text-sm mb-1">
            <span>Tiffin Center:</span>
            <span>{selectedTiffinCenter.name}</span>
          </div>
          
          <div className="flex justify-between text-sm mb-1">
            <span>Package:</span>
            <span>{selectedPackage.name}</span>
          </div>
          
          <div className="flex justify-between text-sm mb-1">
            <span>Package Description:</span>
            <span>{selectedPackage.description}</span>
          </div>
          
          <div className="flex justify-between font-semibold text-sm mt-3 pt-3 border-t">
            <span>Total Amount:</span>
            <span>₹{selectedPackage.price}</span>
          </div>
        </div>
        
        {/* Delivery Address */}
        <div className="bg-white p-4 border-b">
          <div className="flex justify-between items-center mb-2">
            <h3 className="font-semibold">Delivery Address</h3>
            <button 
              onClick={() => goToView('location')}
              className="text-green-600 text-sm"
            >
              Change
            </button>
          </div>
          <p className="text-sm">{user.location}</p>
        </div>
        
        {/* Payment Method */}
        <div className="bg-white p-4">
          <h3 className="font-semibold mb-3">Payment Method</h3>
          
          <div className="space-y-2">
            {paymentMethods.map(method => (
              <div 
                key={method.id}
                className={`flex items-center p-3 border rounded-lg cursor-pointer ${formData.paymentMethod === method.id ? 'border-green-600' : ''}`}
                onClick={() => handlePaymentMethodChange(method)}
              >
                <span className="text-xl mr-3">{method.icon}</span>
                <div className="flex-1">
                  <span className="font-medium">{method.name}</span>
                  {method.coming && (
                    <span className="ml-2 text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded">
                      Coming Soon
                    </span>
                  )}
                </div>
                {formData.paymentMethod === method.id && (
                  <span className="text-green-600">✓</span>
                )}
              </div>
            ))}
          </div>
        </div>
        
        {/* Error Message */}
        {error && (
          <div className="p-3 bg-red-50 border border-red-100 text-red-500 text-sm">
            {error}
          </div>
        )}
        
        {/* Place Order Button */}
        <div className="p-4 bg-white border-t mt-auto">
          <button
            onClick={handleCheckout}
            className={`w-full py-3 px-4 rounded-md text-white font-medium ${THEME.primary} ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
            disabled={loading}
          >
            {loading ? 'Processing Order...' : `Pay ₹${selectedPackage.price} & Place Order`}
          </button>
        </div>
      </div>
    );
  };
  
  // Render order tracking view
  const renderOrderTrackingView = () => {
    if (!currentOrder || !deliveryPartner) return null;
    
    // Calculate progress based on delivery status
    const statusFlow = ['Preparing', 'Ready for pickup', 'Picked up', 'On the way', 'Arriving', 'Delivered'];
    const currentStatusIndex = statusFlow.indexOf(deliveryStatus);
    const progressPercentage = (currentStatusIndex / (statusFlow.length - 1)) * 100;
    
    return (
      <div className="flex flex-col w-full max-w-md mx-auto">
        {/* Header */}
        <div className="flex justify-between items-center p-4 bg-white shadow-sm">
          <Logo size="small" />
          <span className="text-sm font-medium">Order #{currentOrder.orderId.slice(-4)}</span>
        </div>
        
        {/* Status Banner */}
        <div className="bg-green-600 text-white p-4">
          <h2 className="text-xl font-semibold mb-1">Your tiffin is on the way!</h2>
          <p>Estimated delivery by {deliveryETA}</p>
        </div>
        
        {/* Progress Bar */}
        <div className="bg-white p-4 border-b">
          <div className="h-2 w-full bg-gray-200 rounded overflow-hidden">
            <div 
              className="h-full bg-green-600" 
              style={{ width: `${progressPercentage}%` }}
            ></div>
          </div>
          
          <div className="mt-3 text-center">
            <span className="font-semibold">{deliveryStatus}</span>
          </div>
        </div>
        
        {/* Delivery Partner */}
        <div className="bg-white p-4 border-b">
          <h3 className="font-semibold mb-3">Delivery Partner</h3>
          
          <div className="flex items-center">
            <img 
              src={deliveryPartner.image} 
              alt={deliveryPartner.name} 
              className="w-16 h-16 rounded-full object-cover mr-4"
            />
            <div className="flex-1">
              <h4 className="font-semibold">{deliveryPartner.name}</h4>
              <div className="flex items-center text-sm">
                <span className="mr-2 flex items-center">
                  <span className="text-yellow-500 mr-1">★</span>
                  {deliveryPartner.rating}
                </span>
              </div>
            </div>
            <button className="w-10 h-10 flex items-center justify-center bg-green-100 text-green-600 rounded-full">
              <span className="text-lg">📞</span>
            </button>
          </div>
        </div>
        
        {/* Order Details */}
        <div className="bg-white p-4 border-b">
          <h3 className="font-semibold mb-3">Order Details</h3>
          
          <div className="flex justify-between text-sm mb-1">
            <span>Tiffin Center:</span>
            <span>{currentOrder.tiffinCenterName}</span>
          </div>
          
          <div className="flex justify-between text-sm mb-1">
            <span>Package:</span>
            <span>{currentOrder.packageName}</span>
          </div>
          
          <div className="flex justify-between font-semibold text-sm mt-3 pt-3 border-t">
            <span>Total Paid:</span>
            <span>₹{currentOrder.packagePrice}</span>
          </div>
        </div>
        
        {/* Back to Home Button */}
        <div className="p-4 bg-white">
          <button
            onClick={() => goToView('tiffinCenters')}
            className={`w-full py-2 px-4 rounded-md font-medium ${THEME.secondary}`}
          >
            Back to Home
          </button>
        </div>
      </div>
    );
  };
  
  // Render radius extension modal
  const renderRadiusModal = () => {
    if (!showRadiusModal) return null;
    
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
          <h3 className="text-lg font-semibold mb-3">Extend Search Radius</h3>
          
          <p className="text-gray-600 mb-4">
            Pay ₹{CONFIG.RADIUS_EXTENSION_PRICE} to remove distance restrictions and see all available tiffin centers in your city.
          </p>
          
          <div className="flex justify-end space-x-3">
            <button
              onClick={() => setShowRadiusModal(false)}
              className="py-2 px-4 rounded-md font-medium bg-gray-100"
            >
              Cancel
            </button>
            
            <button
              onClick={handleRadiusExtension}
              className={`py-2 px-4 rounded-md text-white font-medium ${THEME.primary} ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
              disabled={loading}
            >
              {loading ? 'Processing...' : `Pay ₹${CONFIG.RADIUS_EXTENSION_PRICE}`}
            </button>
          </div>
        </div>
      </div>
    );
  };
  
  // Render order success modal
  const renderOrderSuccessModal = () => {
    if (!showOrderSuccess) return null;
    
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 text-center">
          <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span className="text-green-600 text-3xl">✓</span>
          </div>
          
          <h3 className="text-xl font-semibold mb-2">Order Placed Successfully!</h3>
          <p className="text-gray-600 mb-1">Your order has been confirmed.</p>
          <p className="text-gray-600">You can track your delivery status.</p>
        </div>
      </div>
    );
  };
  // Main render function
  return (
    <div className="min-h-screen bg-gray-100">
      {currentView === 'login' && renderAuthView()}
      {currentView === 'location' && renderLocationView()}
      {currentView === 'tiffinCenters' && renderTiffinCentersView()}
      {currentView === 'packageSelection' && renderPackageSelectionView()}
      {currentView === 'checkout' && renderCheckoutView()}
      {currentView === 'trackOrder' && renderOrderTrackingView()}
      
      {/* Modals */}
      {renderRadiusModal()}
      {renderOrderSuccessModal()}
    </div>
  );
};

export default TiffinApp;
